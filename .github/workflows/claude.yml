name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read        # Read code (not push commits)
      pull-requests: write  # POST comments on PRs
      issues: write         # POST comments on issues
      id-token: write
      actions: read         # Read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Setup devenv cache
        uses: cachix/cachix-action@v16
        with:
          name: devenv

      - name: Install devenv and direnv
        run: nix profile install nixpkgs#devenv nixpkgs#direnv

      - name: Build devenv and export environment
        run: |
          devenv shell -- true
          direnv allow .
          direnv export gha >> "$GITHUB_ENV"

      - name: Setup environment
        run: cp .env.example .env

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          additional_permissions: |
            actions: read

          prompt: |
            Read CLAUDE.md first for project-specific coding standards and patterns.

            **Environment:**
            The devenv environment is pre-loaded. Tools like bun, git, and jq are available directly. Supabase CLI is available via bun.

            **Available Commands:**
            - `bun run dev` - Start the dev server (http://127.0.0.1:3000)
            - `bun run fix:all` - Run linting, formatting, and type checking
            - `bun test` - Run unit tests
            - `bun run supabase db start` - Start local Supabase database
            - `bun run db:generate-types` - Regenerate DB types

            **When to use the dev environment:**
            - Only start the dev server or database if needed to investigate the issue
            - Always run `bun run fix:all` before suggesting code changes to verify they pass checks
            - Run tests if the changes affect tested code paths

            **Instructions:**
            Follow the instructions in the comment that tagged you. Use the dev environment tools as needed to provide accurate analysis and suggestions.
