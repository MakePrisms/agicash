name: CI Pipeline

on:
  pull_request:

jobs:
  code-checks:
    name: "Format, Lint, and Types Check"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Run Format, Lint, and Types Check
        run: bun run check:all

      - name: Database Types Check
        run: |
          bun supabase db start
          bun supabase gen types typescript --local --schema wallet > supabase/database.types.ts
          if ! git diff --ignore-space-at-eol --exit-code --quiet supabase/database.types.ts; then
            echo "Detected uncommitted changes in database types. This means that db was changed but types were not updated. To fix regenerate the types and commit the changes. See missing types below:"
            git diff
            exit 1
          fi

  unit-tests:
    name: "Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Run Unit Tests
        run: bun test

  e2e-tests:
    name: "E2E Tests"
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-environment

      - name: Install Playwright Browsers
        run: bunx playwright install --with-deps

      - name: Run E2E Tests
        run: bun run test:e2e

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30